<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Capital Admin ‚Ä¢ Town of Sutton</title>

<link rel="stylesheet" href="styles/cip-styles.css">
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- Local per-page tweaks (tiny) -->
<style>
  /* keeps page width consistent with the design system */
  .wrap{max-width:1100px;margin:2rem auto;padding:0 1rem}
</style>
</head>
<body class="theme-light">
  <!-- Brand Header -->
  <header class="brandbar">
    <div class="brandbar__inner">
      <a class="brandbar__logo" href="/"><span class="brandbar__seal">üèõÔ∏è</span></a>
      <div class="brandbar__titles">
        <div class="brandbar__title">Town of Sutton</div>
        <div class="brandbar__subtitle">Capital Improvement Program</div>
      </div>
      <nav class="brandbar__nav">
        <a href="/capital.html">Public Capital</a>
        <a href="/capital-plan.html">Plan Viewer</a>
        <a href="/capital-admin.html" class="active">Admin</a>
      </nav>
    </div>
  </header>

  <!-- Subheader band shows who‚Äôs signed in -->
  <div class="subhead">
    <div class="subhead__inner">
      <div id="who" class="subhead__who">Not signed in</div>
      <div id="auth" class="subhead__auth">
        <div id="g_id_onload"
          data-client_id="1053304257177-rvreds5b4j328d2p7n5dfvvo3u58r3v2.apps.googleusercontent.com"
          data-callback="onGoogleSignIn"
          data-ux_mode="popup"
          data-use_fedcm_for_prompt="false"
          data-auto_select="false"></div>
        <div class="g_id_signin" data-type="standard"></div>
      </div>
    </div>
  </div>

  <!-- Page Content -->
  <main class="wrap">
    <h1 class="page-title">Capital Admin</h1>

    <!-- STAFF PANEL -->
    <section id="staff" class="card" style="display:none">
      <div class="card__header">
        <h2 class="card__title">My Projects</h2>
        <div class="card__actions">
          <button class="btn btn-primary" onclick="newProject()">+ New Project</button>
        </div>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr><th>Title</th><th>Status</th><th>Updated</th><th></th></tr>
          </thead>
          <tbody id="my-projects"></tbody>
        </table>
      </div>

      <h3 id="edit-title" class="section-title">Create / Edit Project</h3>
      <div class="grid grid-2">
        <div><label class="label">Title<input class="input" id="p-title"></label></div>
        <div>
  <label class="label">Category
    <select class="input" id="p-category"></select>
  </label>
</div>
        <div><label class="label">Location<input class="input" id="p-location"></label></div>
        <div class="grid grid-2 grid-span-2">
          <div><label class="label">Description<textarea class="input" id="p-description" rows="4"></textarea></label></div>
          <div><label class="label">Justification<textarea class="input" id="p-justification" rows="4"></textarea></label></div>
        </div>
      </div>

      <h3 class="section-title">Maintenance & Operating Impact</h3>
      <div class="grid grid-2">
        <div><label class="label">Annual O&M Cost (est.)<input class="input" id="p-om" type="number" min="0" step="1" placeholder="e.g., 5000"></label></div>
        <div><label class="label">Lifecycle (years)<input class="input" id="p-life" type="number" min="0" step="1" placeholder="e.g., 15"></label></div>
        <div><label class="label">One-time Startup Cost<input class="input" id="p-startup" type="number" min="0" step="1" placeholder="e.g., 20000"></label></div>
        <div><label class="label">Maintenance Notes<textarea class="input" id="p-maint-notes" rows="2" placeholder="e.g., scheduled replacements, warranties, etc."></textarea></label></div>
      </div>

      <h3 class="section-title">Attachments</h3>
      <div class="card card--soft">
        <iframe name="uploadFrame" id="uploadFrame" style="display:none"></iframe>
        <form id="uploadForm" target="uploadFrame" method="POST" enctype="multipart/form-data" class="row row--gap">
          <input id="p-files" type="file" name="file1" multiple class="file">
          <div class="muted">Upload quotes, spec sheets, photos. You can add more files later.</div>
        </form>
        <div id="upload-msg" class="muted" style="margin-top:.25rem"></div>
      </div>

      <h3 class="section-title">Costs by Year</h3>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>FY</th><th>Base Estimate (today‚Äôs $)</th><th>Funding Source</th><th>Detail</th><th></th></tr></thead>
          <tbody id="cost-rows"></tbody>
        </table>
      </div>
      <div class="row row--gap">
        <button class="btn" onclick="addCostRow()">+ Add Row</button>
        <div class="muted">Town default escalation is applied on the backend‚Äîno inflation input needed.</div>
      </div>

      <div class="row row--gap" style="margin-top:1rem">
        <button class="btn" onclick="saveDraft()">Save Draft</button>
        <button class="btn btn-primary" onclick="submitProject()">Submit for Review</button>
        <div id="save-msg" class="muted"></div>
      </div>
    </section>

    <!-- TM/FINANCE PANEL -->
    <section id="tm" class="card" style="display:none;margin-top:2rem">
      <div class="card__header">
        <h2 class="card__title">Projects</h2>
        <div class="card__actions">
          <label class="label label--inline">Status
            <select id="inbox-status" class="input input--select" onchange="loadInbox()">
              <option value="submitted" selected>Submitted</option>
              <option value="under_review">Under Review</option>
              <option value="recommended">Recommended</option>
              <option value="returned">Returned</option>
              <option value="deferred">Deferred</option>
              <option value="">All</option>
            </select>
          </label>
        </div>
      </div>

      <div class="table-wrap">
        <table class="table table--hover">
          <thead><tr><th>Title</th><th>Dept</th><th>Status</th><th>Score</th><th></th></tr></thead>
          <tbody id="inbox"></tbody>
        </table>
      </div>

      <h3 class="section-title">Scoring</h3>
      <div id="score-banner" class="banner banner--muted"></div>
      <div class="grid grid-2" style="max-width:700px">
        <label class="label">Safety<input class="input" id="sc-safety" type="number" min="0" max="5" step="1" value="0"></label>
        <label class="label">Compliance<input class="input" id="sc-compliance" type="number" min="0" max="5" step="1" value="0"></label>
        <label class="label">Asset Condition<input class="input" id="sc-asset" type="number" min="0" max="5" step="1" value="0"></label>
        <label class="label">Service Demand<input class="input" id="sc-service" type="number" min="0" max="5" step="1" value="0"></label>
        <label class="label">Strategic Alignment<input class="input" id="sc-align" type="number" min="0" max="5" step="1" value="0"></label>
        <label class="label">External Funding<input class="input" id="sc-ext" type="number" min="0" max="5" step="1" value="0"></label>
        <label class="label">ROI<input class="input" id="sc-roi" type="number" min="0" max="5" step="1" value="0"></label>
      </div>
      <div class="row row--gap" style="margin-top:.5rem">
        <input id="score-project-id" type="hidden">
        <button class="btn" onclick="saveScore()">Save Score</button>
        <div id="score-msg" class="muted"></div>
      </div>

      <h3 class="section-title">Plan Snapshot</h3>
      <div class="row row--gap">
        <label class="label label--inline">Phase
          <select id="snap-phase" class="input input--select">
            <option value="tm_recommended">Town Manager Recommend</option>
            <option value="preliminary">Preliminary</option>
            <option value="fincom">FinCom</option>
            <option value="town_meeting">Town Meeting</option>
            <option value="adopted">Adopted</option>
          </select>
        </label>
        <label class="label label--inline">Start FY <input class="input input--sm" id="snap-start" type="number" value="2027"></label>
        <label class="label label--inline">End FY <input class="input input--sm" id="snap-end" type="number" value="2036"></label>
        <label class="label label--inline"><input id="snap-replace" type="checkbox"> Replace existing</label>
        <button class="btn btn-primary" onclick="doSnapshot()">Create Snapshot</button>
        <div id="snap-msg" class="muted"></div>
      </div>
    </section>
  </main>

  <!-- your existing <script> with logic sits below this -->

<script>
  // 1) CHANGE THIS to your Apps Script /exec URL:
  const API = 'https://script.google.com/macros/s/AKfycby6WaJq0C0A7zEQS7pmUXgcPmgRdJMq_-hrOXFw-ahFIyfn8oQ0_QLV0u4H9dLAjpniNw/exec';

  let ID_TOKEN=null, PROFILE=null, OPTIONS=null;
  let editingProjectId=null;
  let costRows=[];

  // JSONP helpers (avoid CORS)
  let __cbSeq = 0;
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb = '__cb'+(++__cbSeq);
      const s = document.createElement('script');
      window[cb] = (data)=>{ delete window[cb]; s.remove(); resolve(data); };
      s.onerror = ()=>{ delete window[cb]; s.remove(); reject(new Error('Network error')); };
      s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
      document.head.appendChild(s);
    });
  }
  function apiGet(path, qs=''){
    const q = qs ? ('&'+qs) : '';
    return jsonp(`${API}?path=${encodeURIComponent(path)}${q}&id_token=${encodeURIComponent(ID_TOKEN||'')}`);
  }
  function apiPost(target, body){
    const bodyEnc = encodeURIComponent(JSON.stringify(body||{}));
    return jsonp(`${API}?path=/xpost&target=${encodeURIComponent(target)}&id_token=${encodeURIComponent(ID_TOKEN||'')}&body=${bodyEnc}`);
  }

  function showError(msg){
    const el = document.getElementById('who');
    el.textContent = 'Error: ' + msg;
    el.style.color = '#b00020';
  }

  // Google Sign-In
  window.onGoogleSignIn = async (resp)=>{
    try{
      ID_TOKEN = resp.credential;
      OPTIONS = await apiGet('/options'); // funding list & default escalation (if provided by backend)
      const me = await apiGet('/me');
      if(me && me.error) throw new Error(me.error);
      PROFILE = me;
      document.getElementById('who').textContent =
        `${PROFILE.full_name||PROFILE.email} ‚Äî ${PROFILE.role.toUpperCase()} ${PROFILE.org_id? '('+PROFILE.org_id+')':''}`;

      if(PROFILE.role==='staff'){ document.getElementById('staff').style.display='block'; await loadMyProjects(); newProject(); }
      if(PROFILE.role==='tmgr' || PROFILE.role==='finance'){ document.getElementById('tm').style.display='block'; await loadInbox(); }
      if(PROFILE.role==='readonly'){ document.getElementById('who').textContent += ' (read-only)'; }
    }catch(err){ showError(err.message||String(err)); }
  };

  // ----- Staff views
  async function loadMyProjects(){
    const rows = await apiGet('/projects');
    if(rows.error) return showError(rows.error);
    const tb = document.getElementById('my-projects');
    tb.innerHTML = rows.map(r=>`
      <tr>
        <td>${escapeHtml(r.title||'(untitled)')}</td>
        <td>${r.status||''}</td>
        <td>${r.updated_at? new Date(r.updated_at).toLocaleString() : ''}</td>
        <td>
          <button class="btn" onclick="editProject('${r.project_id}')">Edit</button>
          ${ (r.status==='draft' || r.status==='returned') ? `<button class="btn primary" onclick="submitExisting('${r.project_id}')">Submit</button>`:''}
        </td>
      </tr>`).join('');
  }

  function newProject(){
    editingProjectId=null;
    document.getElementById('edit-title').textContent = 'Create Project';
    ['p-title','p-category','p-location','p-description','p-justification','p-om','p-life','p-startup','p-maint-notes'].forEach(id=> document.getElementById(id).value='');
    costRows=[]; renderCostRows();
    document.getElementById('upload-msg').textContent = '';
    document.getElementById('p-files').value = ''; // clear chooser
  }

  async function editProject(id){
    const data = await apiGet('/project','id='+encodeURIComponent(id));
    if(data.error) return showError(data.error);
    editingProjectId = data.project.project_id;
    document.getElementById('edit-title').textContent = 'Edit Project';
    document.getElementById('p-title').value = data.project.title||'';
    document.getElementById('p-category').value = data.project.category||'';
    document.getElementById('p-location').value = data.project.location||'';
    document.getElementById('p-description').value = data.project.description||'';
    document.getElementById('p-justification').value = data.project.justification||'';
    document.getElementById('p-om').value = data.project.annual_om_cost||'';
    document.getElementById('p-life').value = data.project.lifecycle_years||'';
    document.getElementById('p-startup').value = data.project.startup_cost||'';
    document.getElementById('p-maint-notes').value = data.project.maintenance_notes||'';
    costRows = (data.costs||[]).map(c=> ({row_id:c.row_id, fiscal_year:c.fiscal_year, cost_estimate:c.cost_estimate, funding_source:c.funding_source, funding_detail:c.funding_detail}));
    renderCostRows();
  }

  function renderCostRows(){
    const tb = document.getElementById('cost-rows');
    const opts = (OPTIONS && OPTIONS.funding_sources || []).map(s=>`<option value="${escapeAttr(s)}">${escapeHtml(s)}</option>`).join('');
    tb.innerHTML = costRows.map((r,idx)=>`
      <tr>
        <td><input type="number" value="${r.fiscal_year||''}" oninput="costRows[${idx}].fiscal_year=this.value"></td>
        <td><input type="number" value="${r.cost_estimate||''}" oninput="costRows[${idx}].cost_estimate=this.value" placeholder="whole dollars"></td>
        <td>
          <select oninput="costRows[${idx}].funding_source=this.value">
            <option value="">‚Äî Select ‚Äî</option>
            ${opts}
          </select>
        </td>
        <td><input value="${r.funding_detail||''}" oninput="costRows[${idx}].funding_detail=this.value" placeholder="e.g., grant name"></td>
        <td><button class="btn danger" onclick="removeCostRow(${idx})">‚úï</button></td>
      </tr>`).join('');
    // restore selected values
    Array.from(tb.querySelectorAll('tr')).forEach((tr,i)=>{
      const s = tr.querySelector('select');
      if(s && costRows[i] && costRows[i].funding_source) s.value = costRows[i].funding_source;
    });
  }
  function addCostRow(){ costRows.push({}); renderCostRows(); }
  function removeCostRow(i){ costRows.splice(i,1); renderCostRows(); }
  // Fill category select
(function fillCategories(){
  const sel = document.getElementById('p-category');
  sel.innerHTML = `<option value="">‚Äî Select ‚Äî</option>` + (OPTIONS.categories||[]).map(c=>`<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join('');
})();

  async function saveDraft(){
    const proj = collectProject('draft');
    const res = await apiPost('/project', proj);
    if(res.error) return showError(res.error);
    editingProjectId = res.project_id;

    if(costRows.length){
      const r2 = await apiPost('/cost_rows', { project_id: editingProjectId, rows: costRows });
      if(r2.error) return showError(r2.error);
    }
    document.getElementById('save-msg').textContent = 'Saved.';
    loadMyProjects();
  }

  async function submitProject(){
    if(!editingProjectId){ await saveDraft(); } else { await saveDraft(); }

    // Upload files first (if any), then submit
    const files = document.getElementById('p-files').files;
    if(files && files.length){
      document.getElementById('upload-msg').textContent = 'Uploading attachments‚Ä¶';
      const form = document.getElementById('uploadForm');
      form.action = `${API}?path=/upload&id_token=${encodeURIComponent(ID_TOKEN)}&project_id=${encodeURIComponent(editingProjectId)}`;
      window.addEventListener('message', onUploadMessageOnce, { once:true });
      form.submit();
    }else{
      await doSubmit();
    }
    async function submitProject(){
  if(!editingProjectId){ await saveDraft(); } else { await saveDraft(); }

  // Require at least one photo if project has no cover yet
  const proj = await apiGet('/project','id='+encodeURIComponent(editingProjectId));
  const hasCover = proj && proj.project && proj.project.cover_image_url;
  const files = document.getElementById('p-files').files;

  if(!hasCover && (!files || !files.length)){
    showError('Please add at least one image (photo) for this request before submitting.');
    return;
  }

  // Upload files first (if any), then submit ...
  // (rest of your function continues unchanged)
  }
  function onUploadMessageOnce(ev){
    try{
      if(!ev.data || ev.data.type!=='CIP_UPLOAD') return;
      const payload = ev.data.data || {};
      if(payload.error){ showError(payload.error); return; }
      document.getElementById('upload-msg').textContent = `Uploaded ${payload.count||0} file(s).`;
      doSubmit();
    }catch(_){}
  }
  async function doSubmit(){
    const r = await apiPost('/submit', { project_id: editingProjectId });
    if(r.error) return showError(r.error);
    document.getElementById('save-msg').textContent = 'Submitted for review.';
    loadMyProjects();
  }
  async function submitExisting(id){
    editingProjectId = id;
    await submitProject();
  }

  function collectProject(status){
    return {
      project_id: editingProjectId || undefined,
      title: document.getElementById('p-title').value,
      category: document.getElementById('p-category').value,
      location: document.getElementById('p-location').value,
      description: document.getElementById('p-description').value,
      justification: document.getElementById('p-justification').value,
      status: status || 'draft',
      annual_om_cost: valueOrNull('p-om'),
      lifecycle_years: valueOrNull('p-life'),
      startup_cost: valueOrNull('p-startup'),
      maintenance_notes: document.getElementById('p-maint-notes').value
    };
  }
  function valueOrNull(id){
    const v = document.getElementById(id).value.trim();
    return v==='' ? null : +v;
  }

  // ----- TM/Finance
  async function loadInbox(){
    const status = document.getElementById('inbox-status').value || '';
    const q = status ? ('status='+encodeURIComponent(status)) : '';
    const list = await apiGet('/projects', q);
    if(list.error) return showError(list.error);
    const tb = document.getElementById('inbox');

    if(!list.length){
      tb.innerHTML = `<tr><td colspan="5" class="muted">No projects in this view.</td></tr>`;
      return;
    }

    tb.innerHTML = list.map(r=>`
      <tr>
        <td><a href="/capital-project.html?id=${encodeURIComponent(r.project_id)}" target="_blank">${escapeHtml(r.title||'(untitled)')}</a></td>
        <td>${escapeHtml(r.org_id||'')}</td>
        <td>${r.status||''}</td>
        <td>${r.total_score_100 ?? r.total_score ?? ''}</td>
        <td>
          <button class="btn" onclick="setScoreProject('${r.project_id}')">Score</button>
          <button class="btn" onclick="transition(['${r.project_id}'],'under_review')">Under Review</button>
          <button class="btn primary" onclick="transition(['${r.project_id}'],'recommended')">Recommend</button>
          <button class="btn" onclick="transition(['${r.project_id}'],'returned')">Return</button>
          <button class="btn" onclick="transition(['${r.project_id}'],'deferred')">Defer</button>
        </td>
      </tr>`).join('');
  }

  async function setScoreProject(id){
    const data = await apiGet('/project','id='+encodeURIComponent(id));
    if(data.error) return showError(data.error);

    document.getElementById('score-project-id').value = id;
    const p = data.project;
    const sc = data.scores || {};

    document.getElementById('sc-safety').value = sc.safety ?? 0;
    document.getElementById('sc-compliance').value = sc.compliance ?? 0;
    document.getElementById('sc-asset').value = sc.asset_condition ?? 0;
    document.getElementById('sc-service').value = sc.service_demand ?? 0;
    document.getElementById('sc-align').value = sc.strategic_alignment ?? 0;
    document.getElementById('sc-ext').value = sc.external_funding ?? 0;
    document.getElementById('sc-roi').value = sc.return_on_investment ?? 0;

    document.getElementById('score-banner').textContent =
      `Scoring: ${p.title||'(untitled)'} ‚Äî ${p.org_id||''}`;
    document.getElementById('score-msg').textContent = '';
  }

  async function saveScore(){
    const project_id = document.getElementById('score-project-id').value;
    if(!project_id) return alert('Click the Score button on a project first.');

    const body = {
      project_id,
      safety: +document.getElementById('sc-safety').value||0,
      compliance: +document.getElementById('sc-compliance').value||0,
      asset_condition: +document.getElementById('sc-asset').value||0,
      service_demand: +document.getElementById('sc-service').value||0,
      strategic_alignment: +document.getElementById('sc-align').value||0,
      external_funding: +document.getElementById('sc-ext').value||0,
      return_on_investment: +document.getElementById('sc-roi').value||0
    };
    const res = await apiPost('/score', body);
    if(res.error) return showError(res.error);

    document.getElementById('score-msg').textContent =
      (res.total_score_100!=null)
        ? `Saved (Score: ${res.total_score_100} / 100)`
        : `Saved (Composite: ${res.total_score?.toFixed?.(2) ?? res.total_score})`;

    loadInbox(); // refresh table to show updated score
  }

  async function transition(ids, to){
    const res = await apiPost('/transition', { project_ids: ids, to, note:'' });
    if(res.error) return showError(res.error);
    loadInbox();
  }

  async function doSnapshot(){
    const phase_key = document.getElementById('snap-phase').value;
    const window_start_fy = +document.getElementById('snap-start').value;
    const window_end_fy = +document.getElementById('snap-end').value;
    const replace = document.getElementById('snap-replace').checked;
    const res = await apiPost('/snapshot', { phase_key, window_start_fy, window_end_fy, replace });
    if(res.error) return showError(res.error);
    document.getElementById('snap-msg').textContent = 'Snapshot created.';
  }

  // utils
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }
</script>
</body>
</html>
