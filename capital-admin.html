<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Capital Admin</title>

<link rel="stylesheet" href="/cip-styles.css">
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  .wrap{max-width:1100px;margin:2rem auto;padding:0 1rem}
  .row{display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  table{width:100%;border-collapse:collapse} th,td{padding:.5rem;border-bottom:1px solid #eee}
  input,select,textarea{width:100%;padding:.5rem;border:1px solid #ddd;border-radius:.5rem}
  .btn{padding:.45rem .8rem;border-radius:.6rem;border:1px solid #ccc;background:#fff;cursor:pointer}
  .btn.primary{background:#1246a7;color:#fff;border-color:#1246a7}
  .muted{color:#6b7280}
  .danger{color:#b00020}
</style>
</head>
<body>
<div class="wrap">
  <h1>Capital Admin</h1>

  <div id="auth">
    <div id="g_id_onload"
      data-client_id="1053304257177-rvreds5b4j328d2p7n5dfvvo3u58r3v2.apps.googleusercontent.com"
      data-callback="onGoogleSignIn"
      data-ux_mode="popup"
      data-use_fedcm_for_prompt="false"
      data-auto_select="false"></div>
    <div class="g_id_signin" data-type="standard"></div>
  </div>

  <div id="who" class="muted"></div>

  <div id="staff" style="display:none">
    <h2>My Projects</h2>
    <div class="row">
      <button class="btn primary" onclick="newProject()">+ New Project</button>
    </div>
    <table>
      <thead><tr><th>Title</th><th>Status</th><th>Updated</th><th></th></tr></thead>
      <tbody id="my-projects"></tbody>
    </table>

    <h3 id="edit-title" style="margin-top:2rem">Create / Edit Project</h3>
    <div class="grid">
      <div><label>Title<input id="p-title"></label></div>
      <div><label>Category<input id="p-category"></label></div>
      <div><label>Location<input id="p-location"></label></div>
      <div class="grid" style="grid-column:1/-1">
        <div><label>Description<textarea id="p-description" rows="4"></textarea></label></div>
        <div><label>Justification<textarea id="p-justification" rows="4"></textarea></label></div>
      </div>
    </div>

    <h3>Maintenance & Operating Impact</h3>
    <div class="grid">
      <div><label>Annual O&M Cost (est.)<input id="p-om" type="number" min="0" step="1" placeholder="e.g., 5000"></label></div>
      <div><label>Lifecycle (years)<input id="p-life" type="number" min="0" step="1" placeholder="e.g., 15"></label></div>
      <div><label>One-time Startup Cost<input id="p-startup" type="number" min="0" step="1" placeholder="e.g., 20000"></label></div>
      <div><label>Maintenance Notes<textarea id="p-maint-notes" rows="2" placeholder="e.g., scheduled replacements, warranties, etc."></textarea></label></div>
    </div>

    <h3>Attachments</h3>
    <iframe name="uploadFrame" id="uploadFrame" style="display:none"></iframe>
    <form id="uploadForm" target="uploadFrame" method="POST" enctype="multipart/form-data">
      <!-- action is set at runtime: API?path=/upload&id_token=...&project_id=... -->
      <input id="p-files" type="file" name="file1" multiple>
      <div class="muted">Upload quotes, spec sheets, photos, etc. You can add more files later when editing.</div>
    </form>
    <div id="upload-msg" class="muted" style="margin-top:.25rem"></div>

    <h3>Costs by Year</h3>
    <table>
      <thead><tr><th>FY</th><th>Base Estimate (today’s $)</th><th>Funding Source</th><th>Detail</th><th></th></tr></thead>
      <tbody id="cost-rows"></tbody>
    </table>
    <div class="row">
      <button class="btn" onclick="addCostRow()">+ Add Row</button>
      <div class="muted">We’ll apply the Town default escalation on the backend; no need to enter inflation here.</div>
    </div>

    <div class="row" style="margin-top:1rem">
      <button class="btn" onclick="saveDraft()">Save Draft</button>
      <button class="btn primary" onclick="submitProject()">Submit for Review</button>
      <div id="save-msg" class="muted"></div>
    </div>
  </div>

  <div id="tm" style="display:none;margin-top:2rem">
    <h2>Inbox (Submitted)</h2>
    <table>
      <thead><tr><th>Title</th><th>Dept</th><th>Status</th><th>Score</th><th></th></tr></thead>
      <tbody id="inbox"></tbody>
    </table>

    <h3>Scoring</h3>
    <div class="grid" style="max-width:700px">
      <label>Safety<input id="sc-safety" type="number" min="0" max="5" step="1" value="0"></label>
      <label>Compliance<input id="sc-compliance" type="number" min="0" max="5" step="1" value="0"></label>
      <label>Asset Condition<input id="sc-asset" type="number" min="0" max="5" step="1" value="0"></label>
      <label>Service Demand<input id="sc-service" type="number" min="0" max="5" step="1" value="0"></label>
      <label>Strategic Alignment<input id="sc-align" type="number" min="0" max="5" step="1" value="0"></label>
      <label>External Funding<input id="sc-ext" type="number" min="0" max="5" step="1" value="0"></label>
      <label>ROI<input id="sc-roi" type="number" min="0" max="5" step="1" value="0"></label>
    </div>
    <div class="row" style="margin-top:.5rem">
      <input id="score-project-id" type="hidden">
      <button class="btn" onclick="saveScore()">Save Score</button>
    </div>

    <h3 style="margin-top:2rem">Plan Snapshot</h3>
    <div class="row">
      <label>Phase
        <select id="snap-phase">
          <option value="tm_recommended">Town Manager Recommend</option>
          <option value="preliminary">Preliminary</option>
          <option value="fincom">FinCom</option>
          <option value="town_meeting">Town Meeting</option>
          <option value="adopted">Adopted</option>
        </select>
      </label>
      <label>Start FY <input id="snap-start" type="number" value="2027"></label>
      <label>End FY <input id="snap-end" type="number" value="2036"></label>
      <label><input id="snap-replace" type="checkbox"> Replace existing</label>
      <button class="btn primary" onclick="doSnapshot()">Create Snapshot</button>
      <div id="snap-msg" class="muted"></div>
    </div>
  </div>
</div>

<script>
  // 1) CHANGE THIS to your Apps Script /exec URL:
  const API = 'https://script.google.com/macros/s/AKfycby6WaJq0C0A7zEQS7pmUXgcPmgRdJMq_-hrOXFw-ahFIyfn8oQ0_QLV0u4H9dLAjpniNw/exec';

  let ID_TOKEN=null, PROFILE=null, OPTIONS=null;
  let editingProjectId=null;
  let costRows=[];

  // JSONP helpers (no CORS)
  let __cbSeq = 0;
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb = '__cb'+(++__cbSeq);
      const s = document.createElement('script');
      window[cb] = (data)=>{ delete window[cb]; s.remove(); resolve(data); };
      s.onerror = ()=>{ delete window[cb]; s.remove(); reject(new Error('Network error')); };
      s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
      document.head.appendChild(s);
    });
  }
  function apiGet(path, qs=''){
    const q = qs ? ('&'+qs) : '';
    return jsonp(`${API}?path=${encodeURIComponent(path)}${q}&id_token=${encodeURIComponent(ID_TOKEN||'')}`);
  }
  function apiPost(target, body){
    const bodyEnc = encodeURIComponent(JSON.stringify(body||{}));
    return jsonp(`${API}?path=/xpost&target=${encodeURIComponent(target)}&id_token=${encodeURIComponent(ID_TOKEN||'')}&body=${bodyEnc}`);
  }

  function showError(msg){
    const el = document.getElementById('who');
    el.textContent = 'Error: ' + msg;
    el.style.color = '#b00020';
  }

  // Google Sign-In
  window.onGoogleSignIn = async (resp)=>{
    try{
      ID_TOKEN = resp.credential;
      OPTIONS = await apiGet('/options'); // funding list & default escalation
      const me = await apiGet('/me');
      if(me && me.error) throw new Error(me.error);
      PROFILE = me;
      document.getElementById('who').textContent =
        `${PROFILE.full_name||PROFILE.email} — ${PROFILE.role.toUpperCase()} ${PROFILE.org_id? '('+PROFILE.org_id+')':''}`;

      if(PROFILE.role==='staff'){ document.getElementById('staff').style.display='block'; await loadMyProjects(); newProject(); }
      if(PROFILE.role==='tmgr' || PROFILE.role==='finance'){ document.getElementById('tm').style.display='block'; await loadInbox(); }
      if(PROFILE.role==='readonly'){ document.getElementById('who').textContent += ' (read-only)'; }
    }catch(err){ showError(err.message||String(err)); }
  };

  // ----- Staff views
  async function loadMyProjects(){
    const rows = await apiGet('/projects');
    if(rows.error) return showError(rows.error);
    const tb = document.getElementById('my-projects');
    tb.innerHTML = rows.map(r=>`
      <tr>
        <td>${escapeHtml(r.title||'(untitled)')}</td>
        <td>${r.status||''}</td>
        <td>${r.updated_at? new Date(r.updated_at).toLocaleString() : ''}</td>
        <td>
          <button class="btn" onclick="editProject('${r.project_id}')">Edit</button>
          ${ (r.status==='draft' || r.status==='returned') ? `<button class="btn primary" onclick="submitExisting('${r.project_id}')">Submit</button>`:''}
        </td>
      </tr>`).join('');
  }

  function newProject(){
    editingProjectId=null;
    document.getElementById('edit-title').textContent = 'Create Project';
    ['p-title','p-category','p-location','p-description','p-justification','p-om','p-life','p-startup','p-maint-notes'].forEach(id=> document.getElementById(id).value='');
    costRows=[]; renderCostRows();
    document.getElementById('upload-msg').textContent = '';
    document.getElementById('p-files').value = ''; // clear chooser
  }

  async function editProject(id){
    const data = await apiGet('/project','id='+encodeURIComponent(id));
    if(data.error) return showError(data.error);
    editingProjectId = data.project.project_id;
    document.getElementById('edit-title').textContent = 'Edit Project';
    document.getElementById('p-title').value = data.project.title||'';
    document.getElementById('p-category').value = data.project.category||'';
    document.getElementById('p-location').value = data.project.location||'';
    document.getElementById('p-description').value = data.project.description||'';
    document.getElementById('p-justification').value = data.project.justification||'';
    document.getElementById('p-om').value = data.project.annual_om_cost||'';
    document.getElementById('p-life').value = data.project.lifecycle_years||'';
    document.getElementById('p-startup').value = data.project.startup_cost||'';
    document.getElementById('p-maint-notes').value = data.project.maintenance_notes||'';
    costRows = (data.costs||[]).map(c=> ({row_id:c.row_id, fiscal_year:c.fiscal_year, cost_estimate:c.cost_estimate, funding_source:c.funding_source, funding_detail:c.funding_detail}));
    renderCostRows();
  }

  function renderCostRows(){
    const tb = document.getElementById('cost-rows');
    const sel = (val)=> (val ? ` selected` : '');
    const opts = (OPTIONS && OPTIONS.funding_sources || []).map(s=>`<option value="${escapeAttr(s)}">${escapeHtml(s)}</option>`).join('');
    tb.innerHTML = costRows.map((r,idx)=>`
      <tr>
        <td><input type="number" value="${r.fiscal_year||''}" oninput="costRows[${idx}].fiscal_year=this.value"></td>
        <td><input type="number" value="${r.cost_estimate||''}" oninput="costRows[${idx}].cost_estimate=this.value" placeholder="whole dollars"></td>
        <td>
          <select oninput="costRows[${idx}].funding_source=this.value">
            <option value="">— Select —</option>
            ${opts}
          </select>
        </td>
        <td><input value="${r.funding_detail||''}" oninput="costRows[${idx}].funding_detail=this.value" placeholder="e.g., grant name"></td>
        <td><button class="btn danger" onclick="removeCostRow(${idx})">✕</button></td>
      </tr>`).join('');
    // set selected values after rendering
    Array.from(tb.querySelectorAll('tr')).forEach((tr,i)=>{
      const s = tr.querySelector('select');
      if(s && costRows[i] && costRows[i].funding_source) s.value = costRows[i].funding_source;
    });
  }
  function addCostRow(){ costRows.push({}); renderCostRows(); }
  function removeCostRow(i){ costRows.splice(i,1); renderCostRows(); }

  async function saveDraft(){
    const proj = collectProject('draft');
    const res = await apiPost('/project', proj);
    if(res.error) return showError(res.error);
    editingProjectId = res.project_id;

    if(costRows.length){
      const r2 = await apiPost('/cost_rows', { project_id: editingProjectId, rows: costRows });
      if(r2.error) return showError(r2.error);
    }
    document.getElementById('save-msg').textContent = 'Saved.';
    loadMyProjects();
  }

  async function submitProject(){
    if(!editingProjectId){ await saveDraft(); } else { await saveDraft(); }

    // Upload files first (if any), then submit
    const files = document.getElementById('p-files').files;
    if(files && files.length){
      document.getElementById('upload-msg').textContent = 'Uploading attachments…';
      const form = document.getElementById('uploadForm');
      form.action = `${API}?path=/upload&id_token=${encodeURIComponent(ID_TOKEN)}&project_id=${encodeURIComponent(editingProjectId)}`;
      window.addEventListener('message', onUploadMessageOnce, { once:true });
      form.submit();
    }else{
      await doSubmit();
    }
  }
  function onUploadMessageOnce(ev){
    try{
      if(!ev.data || ev.data.type!=='CIP_UPLOAD') return;
      const payload = ev.data.data || {};
      if(payload.error){ showError(payload.error); return; }
      document.getElementById('upload-msg').textContent = `Uploaded ${payload.count||0} file(s).`;
      doSubmit();
    }catch(_){}
  }
  async function doSubmit(){
    const r = await apiPost('/submit', { project_id: editingProjectId });
    if(r.error) return showError(r.error);
    document.getElementById('save-msg').textContent = 'Submitted for review.';
    loadMyProjects();
  }
  async function submitExisting(id){
    editingProjectId = id;
    await submitProject();
  }

  function collectProject(status){
    return {
      project_id: editingProjectId || undefined,
      title: document.getElementById('p-title').value,
      category: document.getElementById('p-category').value,
      location: document.getElementById('p-location').value,
      description: document.getElementById('p-description').value,
      justification: document.getElementById('p-justification').value,
      status: status || 'draft',
      annual_om_cost: valueOrNull('p-om'),
      lifecycle_years: valueOrNull('p-life'),
      startup_cost: valueOrNull('p-startup'),
      maintenance_notes: document.getElementById('p-maint-notes').value
    };
  }
  function valueOrNull(id){
    const v = document.getElementById(id).value.trim();
    return v==='' ? null : +v;
  }

  // ----- TM/Finance
  async function loadInbox(){
    const list = await apiGet('/projects','status=submitted');
    if(list.error) return showError(list.error);
    const tb = document.getElementById('inbox');
    tb.innerHTML = list.map(r=>`
      <tr>
        <td><a href="/capital-project.html?id=${encodeURIComponent(r.project_id)}" target="_blank">${escapeHtml(r.title||'(untitled)')}</a></td>
        <td>${escapeHtml(r.org_id||'')}</td>
        <td>${r.status||''}</td>
        <td>${r.total_score||''}</td>
        <td>
          <button class="btn" onclick="setScoreProject('${r.project_id}')">Score</button>
          <button class="btn primary" onclick="transition(['${r.project_id}'],'recommended')">Recommend</button>
          <button class="btn" onclick="transition(['${r.project_id}'],'under_review')">Under Review</button>
          <button class="btn" onclick="transition(['${r.project_id}'],'returned')">Return</button>
          <button class="btn" onclick="transition(['${r.project_id}'],'deferred')">Defer</button>
        </td>
      </tr>`).join('');
  }
  function setScoreProject(id){ document.getElementById('score-project-id').value=id; }
  async function saveScore(){
    const project_id = document.getElementById('score-project-id').value;
    if(!project_id) return alert('Select a project (Score button)');
    const body = {
      project_id,
      safety: +document.getElementById('sc-safety').value||0,
      compliance: +document.getElementById('sc-compliance').value||0,
      asset_condition: +document.getElementById('sc-asset').value||0,
      service_demand: +document.getElementById('sc-service').value||0,
      strategic_alignment: +document.getElementById('sc-align').value||0,
      external_funding: +document.getElementById('sc-ext').value||0,
      return_on_investment: +document.getElementById('sc-roi').value||0
    };
    const res = await apiPost('/score', body);
    if(res.error) return showError(res.error);
    loadInbox();
  }
  async function transition(ids, to){
    const res = await apiPost('/transition', { project_ids: ids, to, note:'' });
    if(res.error) return showError(res.error);
    loadInbox();
  }
  async function doSnapshot(){
    const phase_key = document.getElementById('snap-phase').value;
    const window_start_fy = +document.getElementById('snap-start').value;
    const window_end_fy = +document.getElementById('snap-end').value;
    const replace = document.getElementById('snap-replace').checked;
    const res = await apiPost('/snapshot', { phase_key, window_start_fy, window_end_fy, replace });
    if(res.error) return showError(res.error);
    document.getElementById('snap-msg').textContent = 'Snapshot created.';
  }

  // utils
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }
</script>
</body>
</html>
