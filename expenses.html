<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sutton Budget Portal - Expenses</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-gray-100">
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold text-gray-800">Sutton Budget Portal</h1>
      <nav class="space-x-6 text-sm font-medium">
        <a href="index.html" class="text-blue-600 hover:underline">Home</a>
        <a href="expenses.html" class="text-blue-600 hover:underline">Expenses</a>
        <a href="#" class="text-gray-400 cursor-not-allowed" title="Coming soon">Revenues</a>
      </nav>
    </div>
  </header>

  <div class="flex">
    <aside class="w-64 bg-white p-4 shadow-md h-screen overflow-y-auto sticky top-[104px]">
      <h2 class="text-lg font-semibold mb-4">Navigate by Function</h2>
      <ul id="sidebarMenu" class="space-y-2 text-sm"></ul>
    </aside>

    <main class="flex-1 p-6 relative">
      <h1 class="text-3xl font-bold mb-4 text-center">Sutton Budget Expenses</h1>

      <div class="text-center mb-6">
        <label for="fundSelector" class="mr-2 font-medium">Select Fund:</label>
        <select id="fundSelector" class="p-2 border rounded">
          <option value="010">General Fund</option>
          <option value="600">Sewer Enterprise Fund</option>
          <option value="610">Transfer Station Enterprise Fund</option>
        </select>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-4 rounded-lg shadow-md">
          <h2 class="text-lg font-semibold mb-2 text-center">FY26 Budget by Function</h2>
          <canvas id="expenseChart" class="w-full h-[250px]"></canvas>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md">
          <h2 class="text-lg font-semibold mb-2 text-center">Multi-Year Comparison by Function Area</h2>
          <canvas id="stackedChart" class="w-full h-[250px]"></canvas>
        </div>
      </div>

     <div class="mt-6 border rounded-lg shadow-md relative">
  <table class="table-auto w-full bg-white">
    <thead>
      <tr>
        <th class="sticky top-[104px] z-50 bg-blue-600 text-white text-left p-3">Account</th>
        <th class="sticky top-[104px] z-50 bg-blue-600 text-white text-left p-3">Description</th>
        <th class="sticky top-[104px] z-50 bg-blue-600 text-white text-left p-3">2023 Actual</th>
        <th class="sticky top-[104px] z-50 bg-blue-600 text-white text-left p-3">2024 Actual</th>
        <th class="sticky top-[104px] z-50 bg-blue-600 text-white text-left p-3">2025 Budget</th>
        <th class="sticky top-[104px] z-50 bg-blue-600 text-white text-left p-3">2026 Budget</th>
        <th class="sticky top-[104px] z-50 bg-blue-600 text-white text-left p-3">$ Change</th>
        <th class="sticky top-[104px] z-50 bg-blue-600 text-white text-left p-3">% Change</th>
      </tr>
    </thead>
    <tbody id="expenseTable" class="text-sm text-gray-700"></tbody>
    <tfoot id="expenseTotal" class="font-bold text-black"></tfoot>
  </table>
</div>
    </main>
  </div>

<script>
const expenseSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTQI0lHBLQexriYO48j0pv5wbmy0e3osDh1m9QPZB9xBkq5KRqqxFrZFroAK5Gg0_NIaTht7c7RPcWQ/pub?output=csv';
const chartOfAccountsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRezgn-Gen4lhkuO13Jm_y1QhYP4UovUyDKuLvGGrKqo1JwqnzSVdsSOr26epUKCkNuWdIQd-mu46sW/pub?output=csv';

let currentFund = "010";
let departmentMap = {};
let functionMap = {};
let function2Map = {};
let expenseData = [];
let chartInstance = null;
let stackedInstance = null;

const predefinedColors = [
  '#4e79a7', '#f28e2b', '#e15759', '#76b7b2',
  '#59a14f', '#edc949', '#af7aa1', '#ff9da7',
  '#9c755f', '#bab0ab', '#1f77b4', '#ff7f0e',
  '#2ca02c', '#d62728', '#9467bd', '#8c564b',
  '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
];

function formatCurrency(num) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    maximumFractionDigits: 0
  }).format(num);
}

function calculateChange(prev, curr) {
  const diff = curr - prev;
  const percent = prev !== 0 ? (diff / prev) * 100 : 0;
  return [diff, percent];
}

function buildSidebar() {
  const sidebar = document.getElementById("sidebarMenu");
  sidebar.innerHTML = '';
  const grouped = {};
  Object.keys(departmentMap).forEach(code => {
    const func = functionMap[code] || "Other";
    const dept = departmentMap[code];
    if (!grouped[func]) grouped[func] = [];
    grouped[func].push({ code, name: dept });
  });
  Object.entries(grouped).forEach(([func, depts]) => {
    const li = document.createElement("li");
    li.innerHTML = `<strong>${func}</strong><ul class="ml-4 space-y-1">${depts.map(d => {
      const anchor = `${d.name.replace(/\\s+/g, '_')}-${func.replace(/\\s+/g, '_')}`;
      return `<li><a href="#${anchor}" class="text-blue-600 hover:underline">${d.name}</a></li>`;
    }).join('')}</ul>`;
    sidebar.appendChild(li);
  });
}

function populateTable(data) {
  const table = document.getElementById("expenseTable");
  const footer = document.getElementById("expenseTotal");
  table.innerHTML = '';
  footer.innerHTML = '';

  const grouped = {};
  let grandTotals = { fy23: 0, fy24: 0, fy25: 0, fy26: 0 };

  data.forEach(row => {
    const account = row["Account Number"];
    const desc = row["Description"] || "";
    const deptCode = account.split("-")[1];
    const funcName = functionMap[deptCode] || "Unknown";
    const deptName = departmentMap[deptCode] || "";
    const fy23 = parseFloat(row["2023 ACTUAL"].replace(/,/g, '')) || 0;
    const fy24 = parseFloat(row["2024 ACTUAL"].replace(/,/g, '')) || 0;
    const fy25 = parseFloat(row["2025 BUDGET"].replace(/,/g, '')) || 0;
    const fy26 = parseFloat(row["2026 BUDGET"].replace(/,/g, '')) || 0;

    if (!grouped[funcName]) grouped[funcName] = {};
    if (!grouped[funcName][deptName]) grouped[funcName][deptName] = [];
    grouped[funcName][deptName].push({ account, desc, fy23, fy24, fy25, fy26 });

    grandTotals.fy23 += fy23;
    grandTotals.fy24 += fy24;
    grandTotals.fy25 += fy25;
    grandTotals.fy26 += fy26;
  });

  for (const func in grouped) {
    let funcTotals = { fy23: 0, fy24: 0, fy25: 0, fy26: 0 };
    for (const dept in grouped[func]) {
      let deptTotals = { fy23: 0, fy24: 0, fy25: 0, fy26: 0 };
      grouped[func][dept].forEach(item => {
        const [diff, percent] = calculateChange(item.fy25, item.fy26);
        table.insertAdjacentHTML("beforeend", `
          <tr class="border-b">
            <td class="p-3">${item.account}</td>
            <td class="p-3">${item.desc}</td>
            <td class="p-3">${formatCurrency(item.fy23)}</td>
            <td class="p-3">${formatCurrency(item.fy24)}</td>
            <td class="p-3">${formatCurrency(item.fy25)}</td>
            <td class="p-3">${formatCurrency(item.fy26)}</td>
            <td class="p-3">${formatCurrency(diff)}</td>
            <td class="p-3">${percent.toFixed(1)}%</td>
          </tr>`);
        deptTotals.fy23 += item.fy23;
        deptTotals.fy24 += item.fy24;
        deptTotals.fy25 += item.fy25;
        deptTotals.fy26 += item.fy26;
      });

      const [deptDiff, deptPct] = calculateChange(deptTotals.fy25, deptTotals.fy26);
      const deptAnchorId = `${dept.replace(/\s+/g, '_')}-${func.replace(/\s+/g, '_')}`;
      table.insertAdjacentHTML("beforeend", `
        <tr class="bg-gray-100 font-semibold" id="${deptAnchorId}">
          <td colspan="2" class="p-3 text-right">Subtotal - ${dept}</td>
          <td class="p-3">${formatCurrency(deptTotals.fy23)}</td>
          <td class="p-3">${formatCurrency(deptTotals.fy24)}</td>
          <td class="p-3">${formatCurrency(deptTotals.fy25)}</td>
          <td class="p-3">${formatCurrency(deptTotals.fy26)}</td>
          <td class="p-3">${formatCurrency(deptDiff)}</td>
          <td class="p-3">${deptPct.toFixed(1)}%</td>
        </tr>`);
      funcTotals.fy23 += deptTotals.fy23;
      funcTotals.fy24 += deptTotals.fy24;
      funcTotals.fy25 += deptTotals.fy25;
      funcTotals.fy26 += deptTotals.fy26;
    }

    const [funcDiff, funcPct] = calculateChange(funcTotals.fy25, funcTotals.fy26);
    table.insertAdjacentHTML("beforeend", `
      <tr class="bg-gray-200 font-bold">
        <td colspan="2" class="p-3 text-right">Subtotal - ${func}</td>
        <td class="p-3">${formatCurrency(funcTotals.fy23)}</td>
        <td class="p-3">${formatCurrency(funcTotals.fy24)}</td>
        <td class="p-3">${formatCurrency(funcTotals.fy25)}</td>
        <td class="p-3">${formatCurrency(funcTotals.fy26)}</td>
        <td class="p-3">${formatCurrency(funcDiff)}</td>
        <td class="p-3">${funcPct.toFixed(1)}%</td>
      </tr>`);
  }

  const [grandDiff, grandPct] = calculateChange(grandTotals.fy25, grandTotals.fy26);
  footer.insertAdjacentHTML("beforeend", `
    <tr class="bg-gray-300 font-extrabold">
      <td colspan="2" class="p-3 text-right">Grand Total</td>
      <td class="p-3">${formatCurrency(grandTotals.fy23)}</td>
      <td class="p-3">${formatCurrency(grandTotals.fy24)}</td>
      <td class="p-3">${formatCurrency(grandTotals.fy25)}</td>
      <td class="p-3">${formatCurrency(grandTotals.fy26)}</td>
      <td class="p-3">${formatCurrency(grandDiff)}</td>
      <td class="p-3">${grandPct.toFixed(1)}%</td>
    </tr>`);
}

function renderChart(data) {
  const chartData = {};
  data.forEach(row => {
    const deptCode = row["Account Number"].split("-")[1];
    const funcName = functionMap[deptCode] || "Unknown";
    const value = parseFloat(row["2026 BUDGET"].replace(/,/g, '')) || 0;
    chartData[funcName] = (chartData[funcName] || 0) + value;
  });

  const labels = Object.keys(chartData);
  const values = Object.values(chartData);
  const colors = labels.map((_, i) => predefinedColors[i % predefinedColors.length]);

  const ctx = document.getElementById("expenseChart").getContext("2d");
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        label: "2026 Budget",
        data: values,
        backgroundColor: colors
      }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });
}

function renderStackedChart(data) {
  const chartData = {};
  const years = ["2023 ACTUAL", "2024 ACTUAL", "2025 BUDGET", "2026 BUDGET"];
  data.forEach(row => {
    const deptCode = row["Account Number"].split("-")[1];
    const func2 = function2Map[deptCode] || "Unknown";
    if (!chartData[func2]) chartData[func2] = [0, 0, 0, 0];
    years.forEach((year, i) => {
      chartData[func2][i] += parseFloat(row[year].replace(/,/g, '')) || 0;
    });
  });

  const ctx = document.getElementById("stackedChart").getContext("2d");
  if (stackedInstance) stackedInstance.destroy();
  stackedInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ["FY23", "FY24", "FY25", "FY26"],
      datasets: Object.entries(chartData).map(([label, values], i) => ({
        label,
        data: values,
        backgroundColor: predefinedColors[i % predefinedColors.length]
      }))
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } },
      scales: { x: { stacked: true }, y: { stacked: true } }
    }
  });
}

document.getElementById("fundSelector").addEventListener("change", e => {
  currentFund = e.target.value;
  loadAndRender();
});

function loadAndRender() {
  const filtered = expenseData.filter(row => row["Account Number"] && row["Account Number"].startsWith(currentFund));
  buildSidebar();
  populateTable(filtered);
  renderChart(filtered);
  renderStackedChart(filtered);
}

Papa.parse(chartOfAccountsUrl, {
  header: true,
  download: true,
  complete: results => {
    results.data.forEach(row => {
      departmentMap[row["DEPT CODE"]] = row["DEPARTMENT"];
      functionMap[row["DEPT CODE"]] = row["FUNCTION_1"] || row["FUNCTION_2"] || "Unknown";
      function2Map[row["DEPT CODE"]] = row["FUNCTION_2"] || row["FUNCTION_1"] || "Unknown";
    });
    Papa.parse(expenseSheetUrl, {
      header: true,
      download: true,
      complete: results => {
        expenseData = results.data;
        loadAndRender();
      }
    });
  }
});
</script>
</body>
</html>
