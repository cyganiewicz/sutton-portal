<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Project ‚Ä¢ Town of Sutton</title>
<link rel="stylesheet" href="styles/cip-styles.css">
<style>.wrap{max-width:1100px;margin:2rem auto;padding:0 1rem}</style>
</head>
<body class="theme-light">
  <header class="brandbar">
    <div class="brandbar__inner">
      <a class="brandbar__logo" href="/"><span class="brandbar__seal">üèõÔ∏è</span></a>
      <div class="brandbar__titles">
        <div class="brandbar__title">Town of Sutton</div>
        <div class="brandbar__subtitle">Capital Improvement Program</div>
      </div>
      <nav class="brandbar__nav">
        <a href="/capital.html">Public Capital</a>
        <a href="/capital-plan.html">Plan Viewer</a>
        <a href="/capital-admin.html">Admin</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div id="project" class="card">
      <div id="header" class="card__header">
        <h1 id="title" class="card__title">Project</h1>
        <span id="badge" class="badge"></span>
      </div>
      <div id="cover" style="margin-bottom:1rem"></div>
      <div class="grid grid-2">
        <div class="card card--soft">
          <h3 class="section-title">Overview</h3>
          <div id="overview"></div>
        </div>
        <div class="card card--soft">
          <h3 class="section-title">Costs by Year</h3>
          <div class="table-wrap">
            <table class="table">
              <thead><tr><th>FY</th><th>Amount</th><th>Funding</th></tr></thead>
              <tbody id="costs"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card card--soft" style="margin-top:1rem">
        <h3 class="section-title">Attachments</h3>
        <div id="attachments" class="muted">None uploaded.</div>
      </div>
    </div>
  </main>

<script>
const API = 'https://script.google.com/macros/s/AKfycby6WaJq0C0A7zEQS7pmUXgcPmgRdJMq_-hrOXFw-ahFIyfn8oQ0_QLV0u4H9dLAjpniNw/exec';

function $(id){return document.getElementById(id);}
function q(k){return new URLSearchParams(location.search).get(k);}
function fmt(n){return Number(n||0).toLocaleString();}

function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb='__cb'+Math.random().toString(36).slice(2);
    const s=document.createElement('script');
    window[cb]=(d)=>{ delete window[cb]; s.remove(); resolve(d); };
    s.onerror=()=>{ delete window[cb]; s.remove(); reject(new Error('Network error')); };
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
    document.head.appendChild(s);
  });
}

(async function init(){
  const id = q('id');
  if(!id){ $('title').textContent='Project Not Found'; return; }
  const data = await jsonp(`${API}?path=/public_project&id=${encodeURIComponent(id)}`);
  if(data.error){ $('title').textContent='Project Not Found'; return; }

  $('title').textContent = data.title || '(Untitled)';
  const badge = (data.project_status||'').toLowerCase();
  $('badge').className = 'badge ' + (badge ? ('badge--'+badge) : ''); 
  $('badge').textContent = badge ? badge.replace('_',' ') : '';

  // cover photo
  if(data.attachments){
    const urls = String(data.attachments||'').split(',').map(s=>s.trim()).filter(Boolean);
    const img = data.cover_image_url || urls.find(u=> /\.(png|jpe?g|webp|gif)$/i.test(u));
    if(img){
      $('cover').innerHTML = `<img src="${img}" alt="project cover" style="width:100%;border-radius:12px;box-shadow:var(--shadow-soft)">`;
    }
    if(urls.length){
      $('attachments').innerHTML = urls.map(u=> `<div><a href="${u}" target="_blank" rel="noopener">${u}</a></div>`).join('');
    }
  }

  $('overview').innerHTML = `
    <div class="muted"><strong>Dept:</strong> ${esc(data.org_id)}</div>
    <div style="margin:.5rem 0">${esc(data.description||'')}</div>
    ${data.justification ? `<div><strong>Justification:</strong> ${esc(data.justification)}</div>`:''}
    ${data.operating_impact ? `<div><strong>Operating Impact:</strong> ${esc(data.operating_impact)}</div>`:''}
  `;

  $('costs').innerHTML = (data.costs||[]).sort((a,b)=>a.fiscal_year-b.fiscal_year).map(c=>`
    <tr><td>${c.fiscal_year}</td><td>$${fmt(c.amount)}</td><td>${esc(c.funding_source||'')}</td></tr>
  `).join('') || `<tr><td colspan="3" class="muted">No scheduled costs.</td></tr>`;
})();

function esc(s){return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}
</script>
</body>
</html>
