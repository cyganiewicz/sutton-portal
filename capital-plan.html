<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Capital Plan ‚Ä¢ Town of Sutton</title>
<link rel="stylesheet" href="styles/cip-styles.css">
<style>.wrap{max-width:1100px;margin:2rem auto;padding:0 1rem}.cards{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}@media(max-width:980px){.cards{grid-template-columns:1fr 1fr}}@media(max-width:640px){.cards{grid-template-columns:1fr}}</style>
</head>
<body class="theme-light">
  <header class="brandbar">
    <div class="brandbar__inner">
      <a class="brandbar__logo" href="/"><span class="brandbar__seal">üèõÔ∏è</span></a>
      <div class="brandbar__titles">
        <div class="brandbar__title">Town of Sutton</div>
        <div class="brandbar__subtitle">Capital Improvement Program</div>
      </div>
      <nav class="brandbar__nav">
        <a href="/capital.html">Public Capital</a>
        <a href="/capital-plan.html" class="active">Plan Viewer</a>
        <a href="/capital-admin.html">Admin</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <h1 class="page-title">Ten-Year Capital Plan</h1>

    <section class="card">
      <div class="card__header">
        <h2 class="card__title">Town Manager Recommended</h2>
      </div>
      <div id="rec-cards" class="cards"></div>
      <div id="rec-empty" class="muted" style="display:none">No recommended items yet.</div>
    </section>

    <section class="card">
      <div class="card__header">
        <h2 class="card__title">All Requests (Comprehensive)</h2>
      </div>
      <div class="table-wrap">
        <table class="table table--hover" id="matrix"></table>
      </div>
    </section>
  </main>

<script>
const API='https://script.google.com/macros/s/AKfycby6WaJq0C0A7zEQS7pmUXgcPmgRdJMq_-hrOXFw-ahFIyfn8oQ0_QLV0u4H9dLAjpniNw/exec';

function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb='__cb'+Math.random().toString(36).slice(2);
    const s=document.createElement('script');
    window[cb]=(d)=>{ delete window[cb]; s.remove(); resolve(d); };
    s.onerror=()=>{ delete window[cb]; s.remove(); reject(new Error('Network error')); };
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
    document.head.appendChild(s);
  });
}
function fmt(n){return Number(n||0).toLocaleString();}
function esc(s){return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}

(async function init(){
  // Determine rolling 10 FY window (FY starts July 1; tweak if your policy is different)
  const now = new Date();
  const baseFY = (now.getMonth()>=6) ? now.getFullYear()+1 : now.getFullYear();
  const startFY = baseFY;
  const endFY = baseFY + 9;

  // 1) Recommended items come from snapshot_plan with phase_key=tm_recommended
  const recommended = await jsonp(`${API}?path=/public_feed&phase_key=tm_recommended&start_fy=${startFY}&end_fy=${endFY}`);
  renderRecommended(recommended);

  // 2) Comprehensive requests = all non-recommended statuses with their costs
  const requests = await jsonp(`${API}?path=/public_requests&start_fy=${startFY}&end_fy=${endFY}`);
  renderMatrix(requests, startFY, endFY);
})();

function renderRecommended(rows){
  const root = document.getElementById('rec-cards');
  const empty = document.getElementById('rec-empty');
  if(!rows || !rows.length){ empty.style.display='block'; root.innerHTML=''; return; }
  empty.style.display='none';

  // group by project
  const byId = {};
  rows.forEach(r=>{
    (byId[r.project_id]=byId[r.project_id]||{title:r.title, org_id:r.org_id, total:0}).total += Number(r.amount||0);
  });

  root.innerHTML = Object.entries(byId).map(([id, p])=>{
    return `
      <a class="card card--soft" href="/capital-project.html?id=${encodeURIComponent(id)}" style="text-decoration:none">
        <div class="badge badge--recommended" style="float:right">recommended</div>
        <div class="section-title" style="margin:0 0 .4rem 0">${esc(p.title||'(untitled)')}</div>
        <div class="muted" style="margin-bottom:.5rem">${esc(p.org_id||'')}</div>
        <div><strong>Total (10yr):</strong> $${fmt(p.total)}</div>
      </a>
    `;
  }).join('');
}

function renderMatrix(requests, startFY, endFY){
  const years = [];
  for(let y=startFY;y<=endFY;y++) years.push(y);

  // build matrix rows per project
  const byId = {};
  (requests||[]).forEach(p=>{
    const row = byId[p.project_id] = byId[p.project_id] || {
      id:p.project_id, title:p.title, org:p.org_id,
      status:(p.project_status||'').toLowerCase(), // submitted/under_review/returned/deferred/draft
      annual: Object.fromEntries(years.map(y=> [y,0])),
      total: 0
    };
    (p.costs||[]).forEach(c=>{
      row.annual[c.fiscal_year] = (row.annual[c.fiscal_year]||0) + Number(c.amount||0);
      row.total += Number(c.amount||0);
    });
  });

  // sort: submitted/under_review first, then others, then by total desc
  const order = {submitted:1, under_review:1, returned:2, deferred:3, draft:4};
  const rows = Object.values(byId).sort((a,b)=>{
    const ao = order[a.status]||9, bo = order[b.status]||9;
    if(ao!==bo) return ao-bo;
    return (b.total||0) - (a.total||0);
  });

  // table header
  const thead = `<thead><tr>
    <th>Project</th><th>Dept</th><th>Status</th>
    ${years.map(y=>`<th class="num">${y}</th>`).join('')}
    <th class="num">Total</th>
  </tr></thead>`;

  // body
  const tbody = rows.map(r=>`
    <tr>
      <td><a href="/capital-project.html?id=${encodeURIComponent(r.id)}">${esc(r.title||'(untitled)')}</a></td>
      <td>${esc(r.org||'')}</td>
      <td>${r.status ? `<span class="badge badge--${r.status}">${r.status.replace('_',' ')}</span>` : ''}</td>
      ${years.map(y=> `<td class="num">${r.annual[y] ? '$'+fmt(r.annual[y]) : ''}</td>`).join('')}
      <td class="num"><strong>${r.total ? '$'+fmt(r.total) : ''}</strong></td>
    </tr>
  `).join('');

  // grand totals by year
  const totals = Object.fromEntries(years.map(y=>[y,0]));
  rows.forEach(r=> years.forEach(y=> totals[y]+= (r.annual[y]||0)));
  const grand = years.map(y=> `<td class="num"><strong>${totals[y] ? '$'+fmt(totals[y]) : ''}</strong></td>`).join('');
  const tfoot = `<tfoot><tr>
    <td colspan="3"><strong>Totals</strong></td>${grand}<td></td>
  </tr></tfoot>`;

  document.getElementById('matrix').innerHTML = thead + '<tbody>'+tbody+'</tbody>' + tfoot;
}
</script>
</body>
</html>
